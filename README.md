# Инструкция по установке и запуску проекта

## Минимально допустимые требования

- **NodeJS**: v21.7.3
- **Docker**: v27.2.1

## Шаги установки

### 1. Клонирование репозитория
Склонируйте ветку `develop` из рабочего репозитория Gitlab:

```bash
git clone {Ссылка на репозиторий} -b {Имя рабочей ветки}
```

### 2. Создание файла переменных окружения
В корне проекта создайте файл `.env` и добавьте в него данные из `.env.example`.

### 3. Установка локальных зависимостей
Выполните команду для установки зависимостей:

```bash
npm ci
```

### 4. Установка и запуск Docker-контейнеров
Для установки и запуска необходимого ПО используйте следующую команду:

```bash
docker-compose up -d
```

### 5. Работа с миграциями

Для работы с миграциями в проекте, выполните следующие команды:

#### 1. Запуск миграции
Запустите миграцию для применения изменений:

```bash
npm run migration:run
```

#### 2. Генерация миграции
Для генерации новой миграции на основе изменений в сущностях выполните команду:

```bash
npm run migration:generate --name=MigrationName
```

Миграция будет сгенерирована в папке `./src/migrations/`.

#### 3. Создание миграции вручную
Чтобы создать пустую миграцию:

```bash
npm run migration:create --name=MigrationName
```

Замените `<имя_миграции>` на название вашей миграции.

#### 4. Отмена последней миграции
Для отката последней миграции:

```bash
npm run migration:revert
```

### 6. Запуск приложения и тестов
После установки зависимостей и контейнеров в Docker запустите приложение в режиме разработки:

```bash
npm run start:dev
```

Для запуска тестов выполните команду:

```bash
npm run test
```

Если вы хотите запустить тесты в режиме наблюдения (с автоматическим повторным запуском при изменении файлов), используйте:

```bash
npm run test:watch
```

Эти команды выполнит все тесты, которые находятся в вашем проекте, и выведут результаты в консоль. Убедитесь, что все тесты проходят успешно, прежде чем продолжить разработку.

---

## Эндпоинты AuthController

1. **POST `/auth/register`**
   - **Описание**: Регистрация нового пользователя.
   - **Тело запроса**:
     ```json
     {
       "firstName": "John",
       "lastName": "Doe",
       "email": "john.doe@example.com",
       "password": "Password123"
     }
     ```
   - **Ответ**:
     - Успех: объект `User` или `{ message: 'User registered successfully' }`
     - Ошибка: Сообщение об ошибке, если регистрация не удалась.

2. **POST `/auth/login`**
   - **Описание**: Авторизация пользователя и установка токенов доступа и обновления в cookies.
   - **Тело запроса**:
     ```json
     {
       "email": "john.doe@example.com",
       "password": "Password123"
     }
     ```
   - **Ответ**:
     - Успех: `{ message: 'Login successful' }`
   - **Cookies**:
     - `access_token`: срок действия 1 час
     - `refresh_token`: срок действия 7 дней

3. **POST `/auth/refresh-tokens`**
   - **Описание**: Обновление токенов доступа и обновления.
   - **Guards**: Доступно только для авторизованных пользователей (через `AuthGuard`).
   - **Запрос**: Информация о пользователе передается через `req['user']`.
   - **Ответ**:
     - Успех: `{ message: 'Tokens refreshed' }`
   - **Cookies**:
     - Новый `access_token` и `refresh_token` (1 час и 7 дней соответственно)

4. **POST `/auth/logout`**
   - **Описание**: Выход пользователя и удаление cookies с токенами.
   - **Guards**: Доступно только для авторизованных пользователей (через `AuthGuard`).
   - **Ответ**:
     - Успех: `{ message: 'Logged out successfully' }`
   - **Cookies**:
     - Удаляет `access_token` и `refresh_token`

---

## Эндпоинты ShortenerController

1. **POST `/shorten`**
   - **Описание**: Создает сокращенную ссылку.
   - **Guards**: Доступно только для авторизованных пользователей (через `AuthGuard`).
   - **Тело запроса**:
     ```json
     {
       "originalUrl": "https://example.com",
       "expiresAt": "2025-02-16T12:00:00Z"
     }
     ```
   - **Ответ**:
     - Успех: Детали созданной короткой ссылки
   - **Информация о пользователе**: `user.sub` используется для связывания ссылки с авторизованным пользователем.

2. **GET `/shorten/:shortUrl`**
   - **Описание**: Перенаправляет на оригинальный URL, связанный с сокращенной ссылкой.
   - **Параметры**: `shortUrl` (идентификатор сокращенной ссылки)
   - **Ответ**: Перенаправление на оригинальный URL

3. **GET `/shorten/info/:shortUrl`**
   - **Описание**: Получение информации о сокращенной ссылке.
   - **Guards**: Доступно только для авторизованных пользователей (через `AuthGuard`).
   - **Параметры**: `shortUrl` (идентификатор сокращенной ссылки)
   - **Ответ**: Информация о сокращенной ссылке, включая детали создания

4. **DELETE `/shorten/:shortUrl`**
   - **Описание**: Удаление сокращенной ссылки.
   - **Guards**: Доступно только для авторизованных пользователей (через `AuthGuard`).
   - **Параметры**: `shortUrl` (идентификатор сокращенной ссылки)
   - **Ответ**: Подтверждение удаления сокращенной ссылки

5. **GET `/shorten/analytics/:shortUrl`**
   - **Описание**: Получение аналитики по сокращенной ссылке.
   - **Параметры**: `shortUrl` (идентификатор сокращенной ссылки)
   - **Ответ**: Данные аналитики по сокращенной ссылке

6. **POST `/shorten/my-custom-alias`**
   - **Описание**: Создает сокращенную ссылку с заданным пользовательским алиасом.
   - **Guards**: Доступно только для авторизованных пользователей (через `AuthGuard`).
   - **Тело запроса**:
     ```json
     {
       "originalUrl": "https://example.com",
       "expiresAt": "2025-02-16T12:00:00Z",
       "alias": "my-custom-alias"
     }
     ```
   - **Ответ**: Созданная сокращенная ссылка с пользовательским алиасом

---

## Примечания

- Убедитесь, что все переменные окружения корректно заполнены.
- Команда `docker-compose` должна выполняться из корня проекта.

## Дополнительная информация

- **Доступ к PgAdmin**  
  Для управления базой данных через PgAdmin:
  - Адрес: `http://localhost:<порт_pgadmin>` (порт указан в `docker-compose.yml`)

- **Очистка среды разработки**  
  Чтобы полностью удалить контейнеры и связанные с ними данные:

```bash
docker-compose down -v
```

---

Следуя этой инструкции, вы сможете развернуть проект, настроить его окружение и успешно запустить приложение. При возникновении дополнительных вопросов обратитесь к разработчикам или прочтите соответствующую документацию.